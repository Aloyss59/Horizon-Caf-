# Database Persistence Fix

## Problem
Les comptes créés étaient perdus à chaque redémarrage du serveur sur Render.

## Root Cause
- **Render** ne persiste pas les fichiers SQLite entre redémarrages
- La configuration utilisait SQLite localement mais la base de données n'était pas attachée à Render
- À chaque redémarrage, un nouveau système de fichiers était créé

## Solution
1. **Added PostgreSQL database** to Render via `render.yaml`
   - Free tier PostgreSQL instance
   - Automatically provides `DATABASE_URL` environment variable

2. **Updated database configuration** in `backend/config/database.js`
   - Detects `DATABASE_URL` for production (PostgreSQL)
   - Falls back to SQLite for local development

3. **Created init-db.js** 
   - Automatically initializes database on server startup
   - Creates default admin user if doesn't exist
   - Creates welcome message in General channel

4. **Created manual-init.js**
   - Manual script to reinitialize database if needed
   - Usage: `node backend/manual-init.js`

## Render Configuration Changes

Updated `render.yaml` to include:

```yaml
services:
  # PostgreSQL Database (free tier)
  - type: pserv
    name: horizon-cafe-postgres
    plan: free
    
  # Node.js Backend
  - type: web
    name: horizon-cafe-api
    # ... other config
    envVars:
      - key: DATABASE_URL
        fromService:
          type: pserv
          name: horizon-cafe-postgres
          property: connectionString
```

## How It Works Now

1. **First Deploy**: 
   - Render creates PostgreSQL database automatically
   - Backend starts, connects to PostgreSQL
   - `init-db.js` creates all tables and default data
   - Admin user is created (sourdin.aloys@gmail.com)

2. **Subsequent Restarts**:
   - Backend connects to existing PostgreSQL database
   - `init-db.js` checks for existing data
   - Only adds missing data (doesn't delete anything)
   - User accounts persist!

3. **Local Development**:
   - Falls back to SQLite in `backend/horizon_cafe.db`
   - Data persists locally

## Manual Operations

### Initialize Database Manually
```bash
cd backend
node manual-init.js
```

### Seed Database
```bash
cd backend
node seed.js
```

## Environment Variables

On Render, you need to set:
- `JWT_SECRET`: Your JWT secret key
- `FRONTEND_URL`: https://horizon-cafe-api.onrender.com
- `EMAIL_USER`: Gmail address for notifications
- `EMAIL_PASSWORD`: Gmail app password
- `DATABASE_URL`: Auto-generated by Render from PostgreSQL service

`DATABASE_URL` is automatically set by Render when you add the PostgreSQL service!

## Verification

After restarting the server on Render:
1. Check logs: Should see "Database connection successful" ✓
2. Try logging in with: sourdin.aloys@gmail.com / password123
3. Create a new account
4. Restart the server
5. New account should still exist!
